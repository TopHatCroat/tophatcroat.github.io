<!doctype html><html lang=en-gb><head><title>Setup Elasticsearch on CircleCI |</title><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="How to setup an ES cluster on your Circle CI pipeline to do integration testing"><meta name=generator content="Hugo 0.109.0"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Unna"><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans"><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=https://martinovic.blog/css/theme.css><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-9KTDTQ6HHZ","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body><nav class=navigation><a href=/>HOME</a>
<a href=/posts>ARCHIVE</a>
<a href=/tags>TAGS</a>
<a href=/about>ABOUT</a>
<a id=rss href=https://martinovic.blog/index.xml><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>RSS</title><path d="M19.199 24C19.199 13.467 10.533 4.8.0 4.8V0c13.165.0 24 10.835 24 24h-4.801zM3.291 17.415c1.814.0 3.293 1.479 3.293 3.295.0 1.813-1.485 3.29-3.301 3.29C1.47 24 0 22.526.0 20.71s1.475-3.294 3.291-3.295zM15.909 24h-4.665c0-6.169-5.075-11.245-11.244-11.245V8.09c8.727.0 15.909 7.184 15.909 15.91z"/></svg>RSS</a></nav><main class=main><section id=article><h1 class=title>Setup Elasticsearch on CircleCI</h1><div class=meta><time datetime="2021-05-03 00:00:00 +0000 UTC">3 May 2021</time>
<span class=separator>·</span>
<span>445 words</span>
<span class=separator>·</span>
<span>3 minute read</span></div><div class=content><h3 id=this-is-going-to-be-a-short-one>This is going to be a short one
<a href=#this-is-going-to-be-a-short-one class=anchor><svg fill="#444" width="16" height="16" xmlns="http://www.w3.org/2000/svg" fill="currentcolor" class="bi bi-link-45deg" viewBox="0 0 16 16"><path d="M4.715 6.542 3.343 7.914a3 3 0 104.243 4.243l1.828-1.829A3 3 0 008.586 5.5L8 6.086a1.002 1.002.0 00-.154.199 2 2 0 01.861 3.337L6.88 11.45A2 2 0 114.05 8.62l.793-.792a4.018 4.018.0 01-.128-1.287z"/><path d="M6.586 4.672A3 3 0 007.414 9.5l.775-.776a2 2 0 01-.896-3.346L9.12 3.55a2 2 0 112.83 2.83l-.793.792c.112.42.155.855.128 1.287l1.372-1.372A3 3 0 108.414 2.844L6.586 4.672z"/></svg></a></h3><p>I&rsquo;m only writing this one because I could not Google exactly what I needed as easily as I expected, so hopefully it might help someone.
Setting up an Elasticsearch instance to test against on CircleCI is actually quite straightforward.</p><p>Your <code>.circleci/config.yml</code> should look something like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>jobs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>build</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>docker</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>circleci/&lt;language&gt;:&lt;version TAG&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>docker.elastic.co/elasticsearch/elasticsearch:7.12.0</span><span class=w> </span><span class=c>#1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>transport.host</span><span class=p>:</span><span class=w> </span><span class=l>localhost</span><span class=w> </span><span class=c>#2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>network.host</span><span class=p>:</span><span class=w> </span><span class=m>127.0.0.1</span><span class=w> </span><span class=c>#3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>http.port</span><span class=p>:</span><span class=w> </span><span class=m>9200</span><span class=w> </span><span class=c>#4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>cluster.name</span><span class=p>:</span><span class=w> </span><span class=l>es-cluster</span><span class=w> </span><span class=c>#5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>discovery.type</span><span class=p>:</span><span class=w> </span><span class=l>single-node</span><span class=w> </span><span class=c>#6</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>xpack.security.enabled</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w> </span><span class=c>#7</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>ES_JAVA_OPTS</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;-Xms256m -Xmx256m&#34;</span><span class=w> </span><span class=c>#8</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nt>steps</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>checkout</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	  </span>- <span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=c>#9</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Wait for ES startup</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=l>dockerize -wait tcp://localhost:9200</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>echo &#34;this is the build job&#34;</span><span class=w>
</span></span></span></code></pre></div><p>First thing to do is to add the Elasticsearch image (<code>#1</code>)to your test image on Circle CI. Circle CI will use the first <code>- image</code> in <code>docker</code> YAML array as a starter image, and every following <code>- image</code> item will be &ldquo;joined&rdquo; into the first image with their ports exposed on localhost.
So in our case, as stated in <code>#2-4</code>, Elasticsearch will start at <code>localhost:9200</code> and that&rsquo;s where it will be available within your tests running on Circle CI.</p><p>Next up is setting the name of the cluster (<code>#5</code>), any name will do, use something that is relevant to you.
Setting discovery type to <em>singe-node</em> in <code>#6</code> is required to make Elasticsearch work when only one instance is running, which is true in our case as we only want a bare bones Elasticsearch cluster to test on.</p><p><code>#7</code> is up to you, it disables security features which you probably don&rsquo;t need on your testing environment, so this just makes things easy, but feel free to enable them if you want to make sure your code runs only on properly secured ES.</p><p>Circle CI has limits on how much memory your images can use, with <em>medium</em> resource class, which is the default, this is 4 GB, so you want to be pretty frugal with memory here.
But you might already be aware of this if you ever saw the dreaded <code>error 137</code>.
I&rsquo;ve found that 256 MB is enough for Elasticsearch to do all I need it to do during testing, much less than that and you start seeing errors during ES start up, you might need more if you are testing some serious workflows with ES, so adjust accordingly.</p><p>Lastly, ES takes some time to start up, so in <code>#9</code> we use <em>dockerize</em> to await the start up of it, because it would be possible for your tests to start befor ES is ready.
<em>dockerize</em> comes preinstalled in standard CircleCI base images.</p><p>And that&rsquo;s it, happy testing.</p></div><div class=tags><a href=https://martinovic.blog/tags/development>development</a>
<a href=https://martinovic.blog/tags/ci>ci</a>
<a href=https://martinovic.blog/tags/devops>devops</a></div></section></main><footer id=footer><div id=social><a class=symbol href=mailto:antonio.martinovic@pm.me rel=me target=_blank><svg fill="#bbb" width="28" height="28" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>email</title><path d="M15.61 12c0 1.99-1.62 3.61-3.61 3.61-1.99.0-3.61-1.62-3.61-3.61.0-1.99 1.62-3.61 3.61-3.61 1.99.0 3.61 1.62 3.61 3.61M12 0C5.383.0.0 5.383.0 12s5.383 12 12 12c2.424.0 4.761-.722 6.76-2.087l.034-.024-1.617-1.879-.027.017A9.494 9.494.0 0112 21.54c-5.26.0-9.54-4.28-9.54-9.54.0-5.26 4.28-9.54 9.54-9.54s9.54 4.28 9.54 9.54a9.63 9.63.0 01-.225 2.05c-.301 1.239-1.169 1.618-1.82 1.568-.654-.053-1.42-.52-1.426-1.661V12A6.076 6.076.0 0012 5.93 6.076 6.076.0 005.93 12 6.076 6.076.0 0012 18.07a6.02 6.02.0 004.3-1.792 3.9 3.9.0 003.32 1.805c.874.0 1.74-.292 2.437-.821.719-.547 1.256-1.336 1.553-2.285.047-.154.135-.504.135-.507l.002-.013c.175-.76.253-1.52.253-2.457.0-6.617-5.383-12-12-12"/></svg></a><a class=symbol href=https://www.github.com/TopHatCroat rel=me target=_blank><svg fill="#bbb" width="28" height="28" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63.0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577.0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93.0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176.0.0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22.0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22.0 1.606-.015 2.896-.015 3.286.0.315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><a class=symbol href=https://www.linkedin.com/in/antonio-martinovi%C4%87-29203210a/ rel=me target=_blank><svg fill="#bbb" width="28" height="28" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>LinkedIn</title><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853.0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601.0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144.0-2.063-.926-2.063-2.065.0-1.138.92-2.063 2.063-2.063 1.14.0 2.064.925 2.064 2.063.0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225.0H1.771C.792.0.0.774.0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2.0 22.222.0h.003z"/></svg></a><a class=symbol href=https://mastodon.social/@sike rel=me target=_blank><svg fill="#bbb" width="28" height="28" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Mastodon</title><path d="M23.268 5.313c-.35-2.578-2.617-4.61-5.304-5.004C17.51.242 15.792.0 11.813.0h-.03c-3.98.0-4.835.242-5.288.309C3.882.692 1.496 2.518.917 5.127.64 6.412.61 7.837.661 9.143c.074 1.874.088 3.745.26 5.611.118 1.24.325 2.47.62 3.68.55 2.237 2.777 4.098 4.96 4.857 2.336.792 4.849.923 7.256.38.265-.061.527-.132.786-.213.585-.184 1.27-.39 1.774-.753a.057.057.0 00.023-.043v-1.809a.052.052.0 00-.02-.041.053.053.0 00-.046-.01 20.282 20.282.0 01-4.709.545c-2.73.0-3.463-1.284-3.674-1.818a5.593 5.593.0 01-.319-1.433.053.053.0 01.066-.054c1.517.363 3.072.546 4.632.546.376.0.75.0 1.125-.01 1.57-.044 3.224-.124 4.768-.422.038-.008.077-.015.11-.024 2.435-.464 4.753-1.92 4.989-5.604.008-.145.03-1.52.03-1.67.002-.512.167-3.63-.024-5.545zm-3.748 9.195h-2.561V8.29c0-1.309-.55-1.976-1.67-1.976-1.23.0-1.846.79-1.846 2.35v3.403h-2.546V8.663c0-1.56-.617-2.35-1.848-2.35-1.112.0-1.668.668-1.67 1.977v6.218H4.822V8.102c0-1.31.337-2.35 1.011-3.12.696-.77 1.608-1.164 2.74-1.164 1.311.0 2.302.5 2.962 1.498l.638 1.06.638-1.06c.66-.999 1.65-1.498 2.96-1.498 1.13.0 2.043.395 2.74 1.164.675.77 1.012 1.81 1.012 3.12z"/></svg></a><a class=symbol href=https://stackoverflow.com/users/4828716/antonio-martinovi%c4%87 rel=me target=_blank><svg fill="#bbb" width="28" height="28" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Stack Overflow</title><path d="M15.725.0l-1.72 1.277 6.39 8.588 1.716-1.277L15.725.0zm-3.94 3.418-1.369 1.644 8.225 6.85 1.369-1.644-8.225-6.85zm-3.15 4.465-.905 1.94 9.702 4.517.904-1.94-9.701-4.517zm-1.85 4.86-.44 2.093 10.473 2.201.44-2.092-10.473-2.203zM1.89 15.47V24h19.19v-8.53h-2.133v6.397H4.021v-6.396H1.89zm4.265 2.133v2.13h10.66v-2.13H6.154z"/></svg></a></div><div class=copyright>© Copyright
2023
<span class=split><svg fill="#bbb" width="15" height="15" id="heart-15" xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 15 15"><path d="M13.91 6.75c-1.17 2.25-4.3 5.31-6.07 6.94-.1903.1718-.4797.1718-.67.0C5.39 12.06 2.26 9 1.09 6.75-1.48 1.8 5-1.5 7.5 3.45 10-1.5 16.48 1.8 13.91 6.75z"/></svg></span>Antonio Martinović</div></footer></body></html>